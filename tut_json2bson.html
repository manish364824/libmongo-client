<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>libmongo-client: JSON to BSON converter</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">libmongo-client
   &#160;<span id="projectnumber">0.1.8</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="tutorial.html">Tutorial</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">JSON to BSON converter </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Now that we have a basic grasp of the library, we'll write a solution to a real life problem: converting JSON to BSON.</p>
<p>Our program will expect correctly formatted JSON, in condensed one-line format, and will output a BSON document for each line of JSON received.</p>
 <div class="fragment"><div class="line"><span class="preprocessor">#define __STRICT_ANSI__ 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &lt;bson.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;json.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;glib.h&gt;</span></div>
</div><!-- fragment --></p>
<p>First, we forward declare the json_to_bson() function, because we'll recursively use it later on: <div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> bson *json_to_bson (<span class="keyword">struct</span> json_object *json);</div>
</div><!-- fragment --></p>
<p>Next, we create the heart of the program, a function that takes a BSON object, a value and a key, and appends the key-value pair to the bson object, with the correct type. <div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">json_key_to_bson_key (bson *b, <span class="keywordtype">void</span> *val,</div>
<div class="line">                      <span class="keyword">const</span> gchar *key)</div>
<div class="line">{</div>
</div><!-- fragment --></p>
<p>We do this by checking the JSON object's type, and acting up on it: <div class="fragment"><div class="line">  <span class="keywordflow">switch</span> (json_object_get_type (val))</div>
<div class="line">    {</div>
</div><!-- fragment --></p>
<p>The boolean, double, integer and string types are easy: we just use the appropriate bson_append_*() function: <div class="fragment"><div class="line">    <span class="keywordflow">case</span> json_type_boolean:</div>
<div class="line">      <a class="code" href="group__bson__append.html#ga6bd3d1aa4e6869c173c3f402d106414a">bson_append_boolean</a> (b, key, json_object_get_boolean (val));</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> json_type_double:</div>
<div class="line">      <a class="code" href="group__bson__append.html#gafd5887727fcd6cdba545acbb0df1a5f4">bson_append_double</a> (b, key, json_object_get_double (val));</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> json_type_int:</div>
<div class="line">      <a class="code" href="group__bson__append.html#gad5d474c266b6ee9278e339eb78126b00">bson_append_int32</a> (b, key, json_object_get_int (val));</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> json_type_string:</div>
<div class="line">      <a class="code" href="group__bson__append.html#ga96b16e53097496dcf333f09d29b04aa8">bson_append_string</a> (b, key, json_object_get_string (val), -1);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
</div><!-- fragment --></p>
<p>Converting a JSON object to BSON is a bit more complicated, yet, straightforward nevertheless: <div class="fragment"><div class="line">    <span class="keywordflow">case</span> json_type_object:</div>
<div class="line">      {</div>
<div class="line">        bson *sub;</div>
<div class="line"></div>
<div class="line">        sub = json_to_bson (val);</div>
<div class="line">        <a class="code" href="group__bson__append.html#gab2673b16bf736e1093fadc32154454be">bson_append_document</a> (b, key, sub);</div>
<div class="line">        <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8">bson_free</a> (sub);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
</div><!-- fragment --></p>
<p>This is one of the reasons we needed to forward-declare json_to_bson(): we're using it to turn the JSON value into BSON, and append it as a subdocument.</p>
<p>Next up: arrays! This is even trickier than sub-documents, as we need to iterate over the elements, and append each individually. But, trickier as it may be, it's still straightforward; <div class="fragment"><div class="line">    <span class="keywordflow">case</span> json_type_array:</div>
<div class="line">      {</div>
<div class="line">        gint pos;</div>
<div class="line">        bson *sub;</div>
<div class="line"></div>
<div class="line">        sub = <a class="code" href="group__bson__object__access.html#ga357437f58074c2dee668a0cae2595b8b">bson_new</a> ();</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (pos = 0; pos &lt; json_object_array_length (val); pos++)</div>
<div class="line">          {</div>
<div class="line">            gchar *nk = g_strdup_printf (<span class="stringliteral">&quot;%d&quot;</span>, pos);</div>
<div class="line"></div>
<div class="line">            json_key_to_bson_key (sub, json_object_array_get_idx (val, pos),</div>
<div class="line">                                  nk);</div>
<div class="line">            g_free (nk);</div>
<div class="line">          }</div>
<div class="line">        <a class="code" href="group__bson__object__access.html#gaa9919014ef9d2e2c1b04efa31e0f2124">bson_finish</a> (sub);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="group__bson__append.html#ga56454238921074e98c1eba40972fe9f3">bson_append_array</a> (b, key, sub);</div>
<div class="line">        <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8">bson_free</a> (sub);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
</div><!-- fragment --></p>
<p>Anything else, we ignore: <div class="fragment"><div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
</div><!-- fragment --></p>
<p><div class="fragment"><div class="line">    }</div>
</div><!-- fragment --></p>
<p><div class="fragment"><div class="line">}</div>
</div><!-- fragment --></p>
<p>And to bind this together with JSON-C's API, we need two more functions. The first one will simply iterate over a JSON object, and call the function we wrote above: <div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">json_to_bson_foreach (bson *b, <span class="keyword">struct</span> json_object *json)</div>
<div class="line">{</div>
<div class="line">  json_object_object_foreach (json, key, val)</div>
<div class="line">    {</div>
<div class="line">      json_key_to_bson_key (b, val, key);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></p>
<p>The next one is another wrapper around this former: it creates a BSON document, calls the foreach method, then finishes the BSON object and we're done: <div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> bson *</div>
<div class="line">json_to_bson (<span class="keyword">struct</span> json_object *json)</div>
<div class="line">{</div>
<div class="line">  bson *b;</div>
<div class="line"></div>
<div class="line">  b = <a class="code" href="group__bson__object__access.html#ga357437f58074c2dee668a0cae2595b8b">bson_new</a> ();</div>
<div class="line">  json_to_bson_foreach (b, json);</div>
<div class="line">  <a class="code" href="group__bson__object__access.html#gaa9919014ef9d2e2c1b04efa31e0f2124">bson_finish</a> (b);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> b;</div>
<div class="line">}</div>
</div><!-- fragment --></p>
<p>We're almost done! All that is left is writing our program's entry point: something that will read the input, turn it into BSON, and write it out:</p>
<p><div class="fragment"><div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">  GIOChannel *input;</div>
<div class="line">  GString *json_str;</div>
<div class="line">  GError *error = NULL;</div>
<div class="line">  <span class="keyword">struct </span>json_tokener *tokener;</div>
</div><!-- fragment --></p>
<p>We do some setting up, creating a new IO channel, and a JSON tokenizer: <div class="fragment"><div class="line"></div>
<div class="line">  input = g_io_channel_unix_new (0);</div>
<div class="line"></div>
<div class="line">  json_str = g_string_new (NULL);</div>
<div class="line">  tokener = json_tokener_new ();</div>
</div><!-- fragment --></p>
<p>Then, until we have something to read... <div class="fragment"><div class="line"></div>
<div class="line">  <span class="keywordflow">while</span> (g_io_channel_read_line_string (input, json_str,</div>
<div class="line">                                        NULL, &amp;error) == G_IO_STATUS_NORMAL)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">struct </span>json_object *json;</div>
<div class="line">      bson *bson;</div>
</div><!-- fragment --></p>
<p>We reset the tokenizer before parsing another line, then parse the JSON we received: <div class="fragment"><div class="line"></div>
<div class="line">      json_tokener_reset (tokener);</div>
<div class="line"></div>
<div class="line">      json = json_tokener_parse_ex (tokener, json_str-&gt;str, json_str-&gt;len);</div>
<div class="line">      <span class="keywordflow">if</span> (!json)</div>
<div class="line">        {</div>
<div class="line">          fprintf (stderr, <span class="stringliteral">&quot;Error parsing json: %s\n&quot;</span>, json_str-&gt;str);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
</div><!-- fragment --></p>
<p>If we received something other than a JSON object, we can't turn that into BSON, so we write an error to STDERR, and skip this line: <div class="fragment"><div class="line"></div>
<div class="line">      <span class="keywordflow">if</span> (json_object_get_type (json) != json_type_object)</div>
<div class="line">        {</div>
<div class="line">          fprintf (stderr,</div>
<div class="line">                   <span class="stringliteral">&quot;Error: json&#39;s top-level object is not object: %s\n&quot;</span>,</div>
<div class="line">                   json_str-&gt;str);</div>
<div class="line">          json_object_put (json);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
</div><!-- fragment --></p>
<p>Otherwise, we turn it into BSON, and write it to STDOUT: <div class="fragment"><div class="line"></div>
<div class="line">      bson = json_to_bson (json);</div>
<div class="line">      json_object_put (json);</div>
<div class="line"></div>
<div class="line">      write (1, <a class="code" href="group__bson__object__access.html#ga053d619f59aa8effe973b5b8077fb57b">bson_data</a> (bson), <a class="code" href="group__bson__object__access.html#ga57fb6a03f8e9948901945f4b5fc0793c">bson_size</a> (bson));</div>
<div class="line"></div>
<div class="line">      <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8">bson_free</a> (bson);</div>
</div><!-- fragment --></p>
<p><div class="fragment"><div class="line">    }</div>
</div><!-- fragment --></p>
<p>And that was our program, a very simple application that turns each line of JSON into BSON.</p>
<p><div class="fragment"><div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu May 22 2014 12:56:25 for libmongo-client by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
