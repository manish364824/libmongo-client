<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libmongo-client: A full-blown application</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="tutorial.html">Tutorial</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>A full-blown application </h1>  </div>
</div>
<div class="contents">
<p>As the next step of our tutorial, we will write a full blown application.</p>
<p>While it does not solve any real-life problems, and what it does is entirely pointless, it nevertheless is a good example to showcase certain patterns one is likely to run into while developing with libmongo-client.</p>
 <div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;<a class="code" href="mongo_8h.html" title="libmongo-client meta-header.">mongo.h</a>&gt;</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
</pre></div></p>
<p>Our first task is to add a handful of items to our test collection. We'll have two static keys, and one that's different for each key. <div class="fragment"><pre class="fragment">
<span class="keyword">static</span> <span class="keywordtype">void</span>
do_inserts (mongo_sync_connection *<a class="code" href="struct__mongo__sync__gridfs.html#a468fad5cfe758d14bfc8451f72dbf787" title="Connection the object is associated to.">conn</a>)
{
  bson *base;
  gint i;
</pre></div></p>
<p>First, we'll build a base BSON object: <div class="fragment"><pre class="fragment">
  base = <a class="code" href="group__bson__object__access.html#gae017cba3a7c5a49981aae92ff26d1ed8" title="Build a BSON object in one go.">bson_build</a>
    (<a class="code" href="group__bson__types.html#ggadac27a93ef69dbe56a6409c68395e5cba83acce0871337a68a22c7c9d7b8c5c4a" title="4byte length + NULL terminated string">BSON_TYPE_STRING</a>, <span class="stringliteral">&quot;tutorial-program&quot;</span>, <span class="stringliteral">&quot;tut_hl_client.c&quot;</span>, -1,
     <a class="code" href="group__bson__types.html#ggadac27a93ef69dbe56a6409c68395e5cba9a106beacbbedfec723680af06b44bbc" title="4byte integer">BSON_TYPE_INT32</a>, <span class="stringliteral">&quot;the answer to life, the universe and everything&quot;</span>, 42,
     <a class="code" href="group__bson__types.html#ggadac27a93ef69dbe56a6409c68395e5cba8da6f27ef8afcaac44402b61731a05df" title="Only used for errors.">BSON_TYPE_NONE</a>);
  <a class="code" href="group__bson__object__access.html#gaa9919014ef9d2e2c1b04efa31e0f2124" title="Finish a BSON object.">bson_finish</a> (base);
</pre></div></p>
<p>Then, we create a copy, append a counter element to the object, insert it, and do this a thousand times over. <div class="fragment"><pre class="fragment">
  <span class="keywordflow">for</span> (i = 0; i &lt; 1000; i++)
    {
      bson *n;

      n = <a class="code" href="group__bson__object__access.html#gad456a97b9a887b96373b8e519d76ecff" title="Create a BSON object from existing data.">bson_new_from_data</a> (<a class="code" href="group__bson__object__access.html#ga053d619f59aa8effe973b5b8077fb57b" title="Return the raw bytestream form of the BSON object.">bson_data</a> (base), <a class="code" href="group__bson__object__access.html#ga57fb6a03f8e9948901945f4b5fc0793c" title="Return the size of a finished BSON object.">bson_size</a> (base) - 1);
      <a class="code" href="group__bson__append.html#gad5d474c266b6ee9278e339eb78126b00" title="Append a 32-bit integer to a BSON object.">bson_append_int32</a> (n, <span class="stringliteral">&quot;counter&quot;</span>, i);
      <a class="code" href="group__bson__object__access.html#gaa9919014ef9d2e2c1b04efa31e0f2124" title="Finish a BSON object.">bson_finish</a> (n);

      <span class="keywordflow">if</span> (!<a class="code" href="group__mongo__sync.html#ga3a2312f2c0a7e6c9a4c8d0eb57051f65" title="Send an insert command to MongoDB.">mongo_sync_cmd_insert</a> (conn, <span class="stringliteral">&quot;lmc.tutorial&quot;</span>, n, NULL))
        {
          fprintf (stderr, <span class="stringliteral">&quot;Error inserting document %d: %s\n&quot;</span>, i,
                   strerror (errno));
          exit (1);
        }
      <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (n);
    }
</pre></div></p>
<p>This was pretty simple, wasn't it? And we even have error handling! Lets finish this function up, and move on.</p>
<p><div class="fragment"><pre class="fragment">  <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (base);
}
</pre></div></p>
<p>Next up comes the interesting part: doing queries. We will use the <a class="el" href="group__mongo__sync__cursor.html">cursor API</a> to iterate over all our results, hiding the gory details of database access behind its convenience layer.</p>
<p><div class="fragment"><pre class="fragment">
<span class="keyword">static</span> <span class="keywordtype">void</span>
do_query (mongo_sync_connection *conn)
{
</pre></div></p>
<p>We'll need a couple of things: a cursor, a query, and a string to store error messages in, if any.</p>
<p><div class="fragment"><pre class="fragment">  mongo_sync_cursor *c;
  bson *query;
  gchar *error = NULL;
</pre></div></p>
<p>Before we can query the database, we must build a query object: <div class="fragment"><pre class="fragment">
  query = <a class="code" href="group__bson__object__access.html#gae017cba3a7c5a49981aae92ff26d1ed8" title="Build a BSON object in one go.">bson_build</a>
    (<a class="code" href="group__bson__types.html#ggadac27a93ef69dbe56a6409c68395e5cba83acce0871337a68a22c7c9d7b8c5c4a" title="4byte length + NULL terminated string">BSON_TYPE_STRING</a>, <span class="stringliteral">&quot;tutorial-program&quot;</span>, <span class="stringliteral">&quot;tut_hl_client.c&quot;</span>, -1,
     <a class="code" href="group__bson__types.html#ggadac27a93ef69dbe56a6409c68395e5cba8da6f27ef8afcaac44402b61731a05df" title="Only used for errors.">BSON_TYPE_NONE</a>);
  <a class="code" href="group__bson__object__access.html#gaa9919014ef9d2e2c1b04efa31e0f2124" title="Finish a BSON object.">bson_finish</a> (query);
</pre></div></p>
<p>Once that is done, we create a cursor, cleverly embedding the <a class="el" href="group__mongo__sync.html#ga0349cd2e80d82f52544dbafe1dcb8cdd" title="Send a query command to MongoDB.">mongo_sync_cmd_query()</a> call into the constructor: <div class="fragment"><pre class="fragment">
  c = <a class="code" href="group__mongo__sync__cursor.html#ga4086f81f5805f6f48f9611ea7ec2fa4c" title="Create a new MongoDB Cursor.">mongo_sync_cursor_new</a> (conn, <span class="stringliteral">&quot;lmc.tutorial&quot;</span>,
                             <a class="code" href="group__mongo__sync.html#ga0349cd2e80d82f52544dbafe1dcb8cdd" title="Send a query command to MongoDB.">mongo_sync_cmd_query</a> (conn, <span class="stringliteral">&quot;lmc.tutorial&quot;</span>, 0,
                                                   0, 10, query, NULL));
  <span class="keywordflow">if</span> (!c)
    {
      fprintf (stderr, <span class="stringliteral">&quot;Error creating the query cursor: %s\n&quot;</span>,
               strerror (errno));
      exit (1);
    }
  <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (query);
</pre></div></p>
<p>Again, we properly handle errors. It is very important to not just blindly assume things will work. While the library tries its best to handle invalid data gracefully, it's easy to get lost between the layers when one forgets to handle error cases at the appropriate level.</p>
<p>But I digress, lets get back to our program!</p>
<p>We have a nice little query cursor, it's time to loop through the database, extract the counter from the current BSON object, and move on: <div class="fragment"><pre class="fragment">
  <span class="keywordflow">while</span> (<a class="code" href="group__mongo__sync__cursor.html#ga321b3b8a39de8b5afd3accd9b9310d22" title="Iterate a MongoDB cursor.">mongo_sync_cursor_next</a> (c))
    {
      bson *b = <a class="code" href="group__mongo__sync__cursor.html#gae40a3a8297fccd66baa5ac4bf82a92bb" title="Retrieve the BSON document at the cursor&amp;#39;s position.">mongo_sync_cursor_get_data</a> (c);
      bson_cursor *bc;
      gint32 cnt;

      <span class="keywordflow">if</span> (!b)
        {
          <span class="keywordtype">int</span> e = errno;

          <a class="code" href="group__mongo__sync.html#gaf58b4929296fa55335f209dbbe7370e2" title="Get the last error from MongoDB.">mongo_sync_cmd_get_last_error</a> (conn, <span class="stringliteral">&quot;lmc&quot;</span>, &amp;error);
          fprintf (stderr, <span class="stringliteral">&quot;Error retrieving cursor data: %s\n&quot;</span>,
                   (error) ? error : strerror (e));
          exit (1);
        }
</pre></div></p>
<p>At this point, we have the current document in the <em>b</em> variable, handled the error case, and as such, we're ready to dig deep into the BSON object! <div class="fragment"><pre class="fragment">
      bc = <a class="code" href="group__bson__cursor.html#ga8020ba70e4514954a5a5ebe37baa2bcb" title="Create a new cursor positioned at a given key.">bson_find</a> (b, <span class="stringliteral">&quot;counter&quot;</span>);
      <a class="code" href="group__bson__cursor.html#ga869b17014b3863a8ae0cda9eb82bb5ac" title="Get the value stored at the cursor, as a 32-bit integer.">bson_cursor_get_int32</a> (bc, &amp;cnt);
      printf (<span class="stringliteral">&quot;\rCounter: %d&quot;</span>, cnt);
</pre></div></p>
<p>And once we're done working with the BSON object, we free the cursor, and the object, and continue the loop. <div class="fragment"><pre class="fragment">
      <a class="code" href="group__bson__cursor.html#gaae32a6eae2be182d26c8f2a79a07ac12" title="Delete a cursor, and free up all resources used by it.">bson_cursor_free</a> (bc);
      <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (b);
    }
</pre></div></p>
<p>And in the end, we emit a newline, and free the cursor to wrap up our query routine. <div class="fragment"><pre class="fragment">  printf (<span class="stringliteral">&quot;\n&quot;</span>);

  <a class="code" href="group__mongo__sync__cursor.html#gad7ceca60dfd310b3205d9776b4ae566e" title="Free a MongoDB cursor.">mongo_sync_cursor_free</a> (c);
}
</pre></div></p>
<p>All that is left now, is the glue that holds this together, and connects to MongoDB: <div class="fragment"><pre class="fragment">
<span class="keywordtype">int</span>
main (<span class="keywordtype">void</span>)
{
  mongo_sync_connection *conn;

  conn = <a class="code" href="group__mongo__sync.html#ga731774e2a0026cda4467193a83b6f64a" title="Synchronously connect to a MongoDB server.">mongo_sync_connect</a> (<span class="stringliteral">&quot;localhost&quot;</span>, 27017, FALSE);
  <span class="keywordflow">if</span> (!conn)
    {
      fprintf (stderr, <span class="stringliteral">&quot;Connection failed: %s\n&quot;</span>, strerror (errno));
      <span class="keywordflow">return</span> 1;
    }

  do_inserts (conn);
  do_query (conn);

  <a class="code" href="group__mongo__sync.html#gab5fa65825c2bc29fdea7d925237556d5" title="Close and free a synchronous MongoDB connection.">mongo_sync_disconnect</a> (conn);
  <span class="keywordflow">return</span> 0;
}
</pre></div></p>
<p>I believe that does not need any further explanation.</p>
<p>As an exercise, one can add another feature: dropping the temporary collection on error. Or perhaps, count the number of documents returned, and see if and how the count changes between subsequent runs of the test program. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Sat Aug 27 2011 13:50:48 for libmongo-client by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
