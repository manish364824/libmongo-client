<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>libmongo-client: A full-blown application</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">libmongo-client
   &#160;<span id="projectnumber">0.1.6.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="tutorial.html">Tutorial</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">A full-blown application </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>As the next step of our tutorial, we will write a full blown application.</p>
<p>While it does not solve any real-life problems, and what it does is entirely pointless, it nevertheless is a good example to showcase certain patterns one is likely to run into while developing with libmongo-client.</p>
 <div class="fragment"><div class="line"><span class="preprocessor">#include &lt;mongo.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
</div><!-- fragment --></p>
<p>Our first task is to add a handful of items to our test collection. We'll have two static keys, and one that's different for each key. <div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">do_inserts (mongo_sync_connection *conn)</div>
<div class="line">{</div>
<div class="line">  bson *base;</div>
<div class="line">  gint i;</div>
</div><!-- fragment --></p>
<p>First, we'll build a base BSON object: <div class="fragment"><div class="line"></div>
<div class="line">  base = <a class="code" href="group__bson__object__access.html#gae017cba3a7c5a49981aae92ff26d1ed8" title="Build a BSON object in one go.">bson_build</a></div>
<div class="line">    (<a class="code" href="group__bson__types.html#ggadac27a93ef69dbe56a6409c68395e5cba83acce0871337a68a22c7c9d7b8c5c4a" title="4byte length + NULL terminated string">BSON_TYPE_STRING</a>, <span class="stringliteral">&quot;tutorial-program&quot;</span>, <span class="stringliteral">&quot;tut_hl_client.c&quot;</span>, -1,</div>
<div class="line">     <a class="code" href="group__bson__types.html#ggadac27a93ef69dbe56a6409c68395e5cba9a106beacbbedfec723680af06b44bbc" title="4byte integer">BSON_TYPE_INT32</a>, <span class="stringliteral">&quot;the answer to life, the universe and everything&quot;</span>, 42,</div>
<div class="line">     <a class="code" href="group__bson__types.html#ggadac27a93ef69dbe56a6409c68395e5cba8da6f27ef8afcaac44402b61731a05df" title="Only used for errors.">BSON_TYPE_NONE</a>);</div>
<div class="line">  <a class="code" href="group__bson__object__access.html#gaa9919014ef9d2e2c1b04efa31e0f2124" title="Finish a BSON object.">bson_finish</a> (base);</div>
</div><!-- fragment --></p>
<p>Then, we create a copy, append a counter element to the object, insert it, and do this a thousand times over. <div class="fragment"><div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 1000; i++)</div>
<div class="line">    {</div>
<div class="line">      bson *n;</div>
<div class="line"></div>
<div class="line">      n = <a class="code" href="group__bson__object__access.html#gad456a97b9a887b96373b8e519d76ecff" title="Create a BSON object from existing data.">bson_new_from_data</a> (<a class="code" href="group__bson__object__access.html#ga053d619f59aa8effe973b5b8077fb57b" title="Return the raw bytestream form of the BSON object.">bson_data</a> (base), <a class="code" href="group__bson__object__access.html#ga57fb6a03f8e9948901945f4b5fc0793c" title="Return the size of a finished BSON object.">bson_size</a> (base) - 1);</div>
<div class="line">      <a class="code" href="group__bson__append.html#gad5d474c266b6ee9278e339eb78126b00" title="Append a 32-bit integer to a BSON object.">bson_append_int32</a> (n, <span class="stringliteral">&quot;counter&quot;</span>, i);</div>
<div class="line">      <a class="code" href="group__bson__object__access.html#gaa9919014ef9d2e2c1b04efa31e0f2124" title="Finish a BSON object.">bson_finish</a> (n);</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">if</span> (!<a class="code" href="group__mongo__sync.html#ga3a2312f2c0a7e6c9a4c8d0eb57051f65" title="Send an insert command to MongoDB.">mongo_sync_cmd_insert</a> (conn, <span class="stringliteral">&quot;lmc.tutorial&quot;</span>, n, NULL))</div>
<div class="line">        {</div>
<div class="line">          fprintf (stderr, <span class="stringliteral">&quot;Error inserting document %d: %s\n&quot;</span>, i,</div>
<div class="line">                   strerror (errno));</div>
<div class="line">          exit (1);</div>
<div class="line">        }</div>
<div class="line">      <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (n);</div>
<div class="line">    }</div>
</div><!-- fragment --></p>
<p>This was pretty simple, wasn't it? And we even have error handling! Lets finish this function up, and move on.</p>
<p><div class="fragment"><div class="line">  <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (base);</div>
<div class="line">}</div>
</div><!-- fragment --></p>
<p>Next up comes the interesting part: doing queries. We will use the <a class="el" href="group__mongo__sync__cursor.html">cursor API</a> to iterate over all our results, hiding the gory details of database access behind its convenience layer.</p>
<p><div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">do_query (mongo_sync_connection *conn)</div>
<div class="line">{</div>
</div><!-- fragment --></p>
<p>We'll need a couple of things: a cursor, a query, and a string to store error messages in, if any.</p>
<p><div class="fragment"><div class="line">  mongo_sync_cursor *c;</div>
<div class="line">  bson *query;</div>
<div class="line">  gchar *error = NULL;</div>
</div><!-- fragment --></p>
<p>Before we can query the database, we must build a query object: <div class="fragment"><div class="line"></div>
<div class="line">  query = <a class="code" href="group__bson__object__access.html#gae017cba3a7c5a49981aae92ff26d1ed8" title="Build a BSON object in one go.">bson_build</a></div>
<div class="line">    (<a class="code" href="group__bson__types.html#ggadac27a93ef69dbe56a6409c68395e5cba83acce0871337a68a22c7c9d7b8c5c4a" title="4byte length + NULL terminated string">BSON_TYPE_STRING</a>, <span class="stringliteral">&quot;tutorial-program&quot;</span>, <span class="stringliteral">&quot;tut_hl_client.c&quot;</span>, -1,</div>
<div class="line">     <a class="code" href="group__bson__types.html#ggadac27a93ef69dbe56a6409c68395e5cba8da6f27ef8afcaac44402b61731a05df" title="Only used for errors.">BSON_TYPE_NONE</a>);</div>
<div class="line">  <a class="code" href="group__bson__object__access.html#gaa9919014ef9d2e2c1b04efa31e0f2124" title="Finish a BSON object.">bson_finish</a> (query);</div>
</div><!-- fragment --></p>
<p>Once that is done, we create a cursor, cleverly embedding the <a class="el" href="group__mongo__sync.html#ga0349cd2e80d82f52544dbafe1dcb8cdd" title="Send a query command to MongoDB.">mongo_sync_cmd_query()</a> call into the constructor: <div class="fragment"><div class="line"></div>
<div class="line">  c = <a class="code" href="group__mongo__sync__cursor.html#ga4086f81f5805f6f48f9611ea7ec2fa4c" title="Create a new MongoDB Cursor.">mongo_sync_cursor_new</a> (conn, <span class="stringliteral">&quot;lmc.tutorial&quot;</span>,</div>
<div class="line">                             <a class="code" href="group__mongo__sync.html#ga0349cd2e80d82f52544dbafe1dcb8cdd" title="Send a query command to MongoDB.">mongo_sync_cmd_query</a> (conn, <span class="stringliteral">&quot;lmc.tutorial&quot;</span>, 0,</div>
<div class="line">                                                   0, 10, query, NULL));</div>
<div class="line">  <span class="keywordflow">if</span> (!c)</div>
<div class="line">    {</div>
<div class="line">      fprintf (stderr, <span class="stringliteral">&quot;Error creating the query cursor: %s\n&quot;</span>,</div>
<div class="line">               strerror (errno));</div>
<div class="line">      exit (1);</div>
<div class="line">    }</div>
<div class="line">  <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (query);</div>
</div><!-- fragment --></p>
<p>Again, we properly handle errors. It is very important to not just blindly assume things will work. While the library tries its best to handle invalid data gracefully, it's easy to get lost between the layers when one forgets to handle error cases at the appropriate level.</p>
<p>But I digress, lets get back to our program!</p>
<p>We have a nice little query cursor, it's time to loop through the database, extract the counter from the current BSON object, and move on: <div class="fragment"><div class="line"></div>
<div class="line">  <span class="keywordflow">while</span> (<a class="code" href="group__mongo__sync__cursor.html#ga321b3b8a39de8b5afd3accd9b9310d22" title="Iterate a MongoDB cursor.">mongo_sync_cursor_next</a> (c))</div>
<div class="line">    {</div>
<div class="line">      bson *b = <a class="code" href="group__mongo__sync__cursor.html#gae40a3a8297fccd66baa5ac4bf82a92bb" title="Retrieve the BSON document at the cursor&#39;s position.">mongo_sync_cursor_get_data</a> (c);</div>
<div class="line">      bson_cursor *bc;</div>
<div class="line">      gint32 cnt;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">if</span> (!b)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordtype">int</span> e = errno;</div>
<div class="line"></div>
<div class="line">          <a class="code" href="group__mongo__sync.html#gaf58b4929296fa55335f209dbbe7370e2" title="Get the last error from MongoDB.">mongo_sync_cmd_get_last_error</a> (conn, <span class="stringliteral">&quot;lmc&quot;</span>, &amp;error);</div>
<div class="line">          fprintf (stderr, <span class="stringliteral">&quot;Error retrieving cursor data: %s\n&quot;</span>,</div>
<div class="line">                   (error) ? error : strerror (e));</div>
<div class="line">          exit (1);</div>
<div class="line">        }</div>
</div><!-- fragment --></p>
<p>At this point, we have the current document in the <em>b</em> variable, handled the error case, and as such, we're ready to dig deep into the BSON object! <div class="fragment"><div class="line"></div>
<div class="line">      bc = <a class="code" href="group__bson__cursor.html#ga8020ba70e4514954a5a5ebe37baa2bcb" title="Create a new cursor positioned at a given key.">bson_find</a> (b, <span class="stringliteral">&quot;counter&quot;</span>);</div>
<div class="line">      <a class="code" href="group__bson__cursor.html#ga869b17014b3863a8ae0cda9eb82bb5ac" title="Get the value stored at the cursor, as a 32-bit integer.">bson_cursor_get_int32</a> (bc, &amp;cnt);</div>
<div class="line">      printf (<span class="stringliteral">&quot;\rCounter: %d&quot;</span>, cnt);</div>
</div><!-- fragment --></p>
<p>And once we're done working with the BSON object, we free the cursor, and the object, and continue the loop. <div class="fragment"><div class="line"></div>
<div class="line">      <a class="code" href="group__bson__cursor.html#gaae32a6eae2be182d26c8f2a79a07ac12" title="Delete a cursor, and free up all resources used by it.">bson_cursor_free</a> (bc);</div>
<div class="line">      <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (b);</div>
<div class="line">    }</div>
</div><!-- fragment --></p>
<p>And in the end, we emit a newline, and free the cursor to wrap up our query routine. <div class="fragment"><div class="line">  printf (<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="group__mongo__sync__cursor.html#gad7ceca60dfd310b3205d9776b4ae566e" title="Free a MongoDB cursor.">mongo_sync_cursor_free</a> (c);</div>
<div class="line">}</div>
</div><!-- fragment --></p>
<p>All that is left now, is the glue that holds this together, and connects to MongoDB: <div class="fragment"><div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  mongo_sync_connection *conn;</div>
<div class="line"></div>
<div class="line">  conn = <a class="code" href="group__mongo__sync.html#ga7f583ef617402135aa8302163358404f" title="Synchronously connect to a MongoDB server.">mongo_sync_connect</a> (<span class="stringliteral">&quot;localhost&quot;</span>, 27017, FALSE);</div>
<div class="line">  <span class="keywordflow">if</span> (!conn)</div>
<div class="line">    {</div>
<div class="line">      fprintf (stderr, <span class="stringliteral">&quot;Connection failed: %s\n&quot;</span>, strerror (errno));</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">  do_inserts (conn);</div>
<div class="line">  do_query (conn);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="group__mongo__sync.html#gab5fa65825c2bc29fdea7d925237556d5" title="Close and free a synchronous MongoDB connection.">mongo_sync_disconnect</a> (conn);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --></p>
<p>I believe that does not need any further explanation.</p>
<p>As an exercise, one can add another feature: dropping the temporary collection on error. Or perhaps, count the number of documents returned, and see if and how the count changes between subsequent runs of the test program. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Nov 10 2012 13:56:05 for libmongo-client by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>
